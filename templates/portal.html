<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalshi Trading Portal</title>
<style>
  :root {
    --bg: #0a0e14;
    --card: #111820;
    --card-border: #1e2a3a;
    --text: #e2e8f0;
    --text-dim: #8899aa;
    --accent: #3b82f6;
    --green: #22c55e;
    --red: #ef4444;
    --orange: #f59e0b;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    padding: 0 1rem;
    height: 48px;
    background: var(--card);
    border-bottom: 1px solid var(--card-border);
    flex-shrink: 0;
  }
  .header h1 {
    font-size: 0.95rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-right: 2rem;
    white-space: nowrap;
  }

  /* Tab bar */
  .tabs {
    display: flex;
    gap: 2px;
    overflow-x: auto;
  }
  .tab {
    padding: 0.6rem 1.2rem;
    cursor: pointer;
    font-size: 0.8rem;
    font-family: inherit;
    border: none;
    background: transparent;
    color: var(--text-dim);
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .tab:hover { color: var(--text); background: rgba(255,255,255,0.03); }
  .tab.active {
    color: var(--text);
    border-bottom-color: var(--accent);
    background: rgba(59,130,246,0.08);
  }
  .tab .dot {
    width: 8px; height: 8px; border-radius: 50%;
    display: inline-block;
    background: var(--text-dim);
  }
  .tab .dot.healthy { background: var(--green); }
  .tab .dot.unhealthy { background: var(--red); }

  /* Panels */
  .panel-container {
    flex: 1;
    position: relative;
    overflow: hidden;
  }
  .panel {
    position: absolute;
    inset: 0;
    display: none;
  }
  .panel.active { display: flex; flex-direction: column; }

  /* Overview panel */
  .overview {
    padding: 1.5rem;
    overflow-y: auto;
  }
  .overview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .overview-header h2 { font-size: 1.1rem; font-weight: 600; }
  .total-pnl {
    font-size: 1.5rem;
    font-weight: 700;
  }
  .total-pnl.positive { color: var(--green); }
  .total-pnl.negative { color: var(--red); }
  .total-pnl.zero { color: var(--text-dim); }

  .bot-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
  }
  .bot-card {
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    padding: 1.25rem;
    border-left: 3px solid var(--text-dim);
    transition: border-color 0.2s;
  }
  .bot-card:hover { border-color: var(--accent); }
  .bot-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .bot-card-title {
    font-size: 0.95rem;
    font-weight: 600;
  }
  .bot-badge {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
  }
  .bot-badge.healthy { background: rgba(34,197,94,0.15); color: var(--green); }
  .bot-badge.unhealthy { background: rgba(239,68,68,0.15); color: var(--red); }
  .bot-badge.unknown { background: rgba(136,153,170,0.15); color: var(--text-dim); }

  .bot-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }
  .stat-item { }
  .stat-label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
  }
  .stat-value {
    font-size: 1rem;
    font-weight: 600;
  }
  .stat-value.positive { color: var(--green); }
  .stat-value.negative { color: var(--red); }

  .bot-card .error-msg {
    color: var(--red);
    font-size: 0.8rem;
    opacity: 0.8;
  }

  .bot-card .open-btn {
    display: inline-block;
    margin-top: 1rem;
    font-size: 0.75rem;
    color: var(--accent);
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
    padding: 0;
  }
  .bot-card .open-btn:hover { text-decoration: underline; }

  /* Refresh indicator */
  .refresh-info {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  /* Iframe panels */
  .panel iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  .iframe-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  /* Capital panel */
  .capital { padding: 1.5rem; overflow-y: auto; }
  .capital-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1.5rem;
  }
  .capital-header h2 { font-size: 1.1rem; font-weight: 600; }
  .capital-total {
    font-size: 1.5rem; font-weight: 700;
  }

  .sub-cards {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1rem; margin-bottom: 2rem;
  }
  .sub-card {
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: 8px; padding: 1.25rem; border-left: 3px solid var(--text-dim);
  }
  .sub-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.75rem;
  }
  .sub-card-label { font-size: 0.95rem; font-weight: 600; }
  .sub-card-badge {
    font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
    background: rgba(59,130,246,0.15); color: var(--accent); font-weight: 600;
  }
  .sub-card-balance {
    font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem;
  }
  .sub-card-bot {
    font-size: 0.75rem; color: var(--text-dim);
  }

  .capital-section {
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem;
  }
  .capital-section h3 {
    font-size: 0.9rem; font-weight: 600; margin-bottom: 1rem;
    color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px;
  }
  .form-row {
    display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap;
  }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-group label {
    font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;
  }
  .form-group select, .form-group input {
    background: var(--bg); border: 1px solid var(--card-border); color: var(--text);
    padding: 0.5rem 0.75rem; border-radius: 4px; font-family: inherit; font-size: 0.85rem;
    min-width: 140px;
  }
  .btn {
    padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;
    font-family: inherit; font-size: 0.8rem; font-weight: 600;
    transition: opacity 0.15s;
  }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-green { background: var(--green); color: #fff; }
  .btn-red { background: var(--red); color: #fff; }
  .btn-small { padding: 0.3rem 0.6rem; font-size: 0.7rem; }

  .feedback {
    margin-top: 0.75rem; font-size: 0.8rem; min-height: 1.2em;
  }
  .feedback.ok { color: var(--green); }
  .feedback.err { color: var(--red); }

  .mgmt-table {
    width: 100%; font-size: 0.8rem; border-collapse: collapse;
  }
  .mgmt-table th, .mgmt-table td {
    padding: 0.5rem 0.75rem; text-align: left;
    border-bottom: 1px solid var(--card-border);
  }
  .mgmt-table th { color: var(--text-dim); font-weight: 600; text-transform: uppercase; font-size: 0.7rem; }
  .mgmt-table input, .mgmt-table select {
    background: var(--bg); border: 1px solid var(--card-border); color: var(--text);
    padding: 0.3rem 0.5rem; border-radius: 4px; font-family: inherit; font-size: 0.8rem;
    width: 100%;
  }
</style>
</head>
<body>

<div class="header">
  <h1>KALSHI PORTAL</h1>
  <div class="tabs" id="tabBar">
    <button class="tab active" data-tab="overview">Overview</button>
    <button class="tab" data-tab="capital">$ Capital</button>
    {% for bot_id, bot in bots.items() %}
    <button class="tab" data-tab="{{ bot_id }}">
      <span class="dot" id="dot-{{ bot_id }}"></span>
      {{ bot.short }}
    </button>
    {% endfor %}
  </div>
</div>

<div class="panel-container">
  <!-- Overview panel -->
  <div class="panel active" id="panel-overview">
    <div class="overview">
      <div class="overview-header">
        <h2>Portfolio Overview</h2>
        <div>
          <span class="total-pnl zero" id="totalPnl">$0.00</span>
          <div class="refresh-info" id="refreshInfo">Loading...</div>
        </div>
      </div>
      <div class="bot-cards" id="botCards"></div>
    </div>
  </div>

  <!-- Capital panel -->
  <div class="panel" id="panel-capital">
    <div class="capital">
      <div class="capital-header">
        <h2>Capital Management</h2>
        <div>
          <span class="capital-total" id="capitalTotal">$0.00</span>
          <div class="refresh-info" id="capitalRefresh">Loading...</div>
        </div>
      </div>

      <div class="sub-cards" id="capitalCards"></div>

      <div class="capital-section">
        <h3>Allocate Capital</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Bot</label>
            <select id="allocBot"></select>
          </div>
          <div class="form-group">
            <label>Label</label>
            <input type="text" id="allocLabel" placeholder="e.g. BTC Range">
          </div>
          <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="allocAmount" min="0" step="0.01" placeholder="0.00">
          </div>
          <button class="btn btn-green" id="allocBtn" onclick="doAllocate()">Allocate</button>
        </div>
        <div class="feedback" id="allocFeedback"></div>
      </div>

      <div class="capital-section">
        <h3>Transfer Funds</h3>
        <div class="form-row">
          <div class="form-group">
            <label>From</label>
            <select id="xferFrom"></select>
          </div>
          <div class="form-group">
            <label>To</label>
            <select id="xferTo"></select>
          </div>
          <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="xferAmount" min="0.01" step="0.01" placeholder="0.00">
          </div>
          <button class="btn btn-primary" id="xferBtn" onclick="doTransfer()">Transfer</button>
        </div>
        <div class="feedback" id="xferFeedback"></div>
      </div>

      <div class="capital-section">
        <h3>Allocations</h3>
        <table class="mgmt-table">
          <thead><tr><th>Bot</th><th>Label</th><th>Allocation</th><th>P&L</th><th>Effective</th><th></th></tr></thead>
          <tbody id="mgmtBody"></tbody>
        </table>
      </div>

      <div class="capital-section">
        <h3>Transfer History</h3>
        <table class="mgmt-table" id="xferHistory">
          <thead><tr><th>Time</th><th>From</th><th>To</th><th>Amount</th></tr></thead>
          <tbody id="xferHistoryBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bot iframe panels -->
  {% for bot_id, bot in bots.items() %}
  <div class="panel" id="panel-{{ bot_id }}">
    <div class="iframe-loading" id="loading-{{ bot_id }}">Loading {{ bot.name }}...</div>
  </div>
  {% endfor %}
</div>

<script>
const BOTS = {{ bots | tojson }};
const BOT_IDS = Object.keys(BOTS);
let overviewData = null;
let loadedIframes = {};

// Tab switching
document.getElementById('tabBar').addEventListener('click', function(e) {
  const tab = e.target.closest('.tab');
  if (!tab) return;
  const target = tab.dataset.tab;

  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById('panel-' + target).classList.add('active');

  // Lazy-load iframe (skip non-bot tabs)
  if (target !== 'overview' && target !== 'capital' && !loadedIframes[target]) {
    loadIframe(target);
  }
});

function loadIframe(botId) {
  loadedIframes[botId] = true;
  const panel = document.getElementById('panel-' + botId);
  const loading = document.getElementById('loading-' + botId);
  const iframe = document.createElement('iframe');
  iframe.src = '/bot/' + botId + '/';
  iframe.onload = function() {
    if (loading) loading.style.display = 'none';
  };
  panel.appendChild(iframe);
}

// Overview rendering
function formatPnl(val) {
  const sign = val >= 0 ? '+' : '';
  return sign + '$' + Math.abs(val).toFixed(2);
}

function pnlClass(val) {
  if (val > 0) return 'positive';
  if (val < 0) return 'negative';
  return 'zero';
}

function renderOverview(data) {
  overviewData = data;

  // Total P&L
  const totalEl = document.getElementById('totalPnl');
  totalEl.textContent = formatPnl(data.total_pnl);
  totalEl.className = 'total-pnl ' + pnlClass(data.total_pnl);

  // Refresh info
  document.getElementById('refreshInfo').textContent =
    'Updated ' + new Date().toLocaleTimeString();

  // Bot cards
  const container = document.getElementById('botCards');
  container.innerHTML = '';

  for (const [botId, bot] of Object.entries(data.bots)) {
    const cfg = BOTS[botId] || {};
    const card = document.createElement('div');
    card.className = 'bot-card';
    card.style.borderLeftColor = bot.color || cfg.color || '#666';

    const isHealthy = bot.healthy;
    const hasError = !!bot.error;

    let statsHtml = '';
    if (hasError) {
      statsHtml = '<div class="error-msg">' + bot.error + '</div>';
    } else {
      statsHtml = '<div class="bot-stats">';
      statsHtml += '<div class="stat-item"><div class="stat-label">P&L</div>' +
        '<div class="stat-value ' + pnlClass(bot.pnl) + '">' + formatPnl(bot.pnl) + '</div></div>';
      statsHtml += '<div class="stat-item"><div class="stat-label">Mode</div>' +
        '<div class="stat-value">' + (bot.mode || 'N/A') + '</div></div>';

      if (bot.win_rate !== undefined) {
        statsHtml += '<div class="stat-item"><div class="stat-label">Win Rate</div>' +
          '<div class="stat-value">' + bot.win_rate + '%</div></div>';
      }
      if (bot.completed !== undefined) {
        statsHtml += '<div class="stat-item"><div class="stat-label">Trades</div>' +
          '<div class="stat-value">' + bot.completed +
          (bot.wins !== undefined ? ' (' + bot.wins + 'W)' : '') + '</div></div>';
      }
      if (bot.open_positions !== undefined) {
        statsHtml += '<div class="stat-item"><div class="stat-label">Open</div>' +
          '<div class="stat-value">' + bot.open_positions + '</div></div>';
      }
      if (bot.daily_trades !== undefined) {
        statsHtml += '<div class="stat-item"><div class="stat-label">Daily Trades</div>' +
          '<div class="stat-value">' + bot.daily_trades + '</div></div>';
      }
      if (bot.running !== undefined) {
        statsHtml += '<div class="stat-item"><div class="stat-label">Running</div>' +
          '<div class="stat-value">' + (bot.running ? 'Yes' : 'No') + '</div></div>';
      }
      statsHtml += '</div>';
    }

    const badgeClass = hasError ? 'unknown' : (isHealthy ? 'healthy' : 'unhealthy');
    const badgeText = hasError ? 'UNREACHABLE' : (isHealthy ? 'HEALTHY' : 'UNHEALTHY');

    card.innerHTML =
      '<div class="bot-card-header">' +
        '<span class="bot-card-title">' + bot.name + '</span>' +
        '<span class="bot-badge ' + badgeClass + '">' + badgeText + '</span>' +
      '</div>' +
      statsHtml +
      '<button class="open-btn" data-bot="' + botId + '">Open Dashboard &rarr;</button>';

    container.appendChild(card);
  }

  // Update tab dots
  for (const [botId, bot] of Object.entries(data.bots)) {
    const dot = document.getElementById('dot-' + botId);
    if (dot) {
      dot.className = 'dot ' + (bot.error ? 'unhealthy' : (bot.healthy ? 'healthy' : 'unhealthy'));
    }
  }
}

// Open bot dashboard from card
document.getElementById('botCards').addEventListener('click', function(e) {
  const btn = e.target.closest('.open-btn');
  if (!btn) return;
  const botId = btn.dataset.bot;
  // Activate the tab
  const tab = document.querySelector('.tab[data-tab="' + botId + '"]');
  if (tab) tab.click();
});

// Fetch overview data
function fetchOverview() {
  fetch('/api/overview')
    .then(r => r.json())
    .then(data => renderOverview(data))
    .catch(err => {
      document.getElementById('refreshInfo').textContent = 'Error: ' + err.message;
    });
}

// Initial load + auto-refresh
fetchOverview();
setInterval(fetchOverview, 5000);

// ---- Capital tab (virtual ledger) ----
let capitalData = null;
let capitalInterval = null;

// Auto-refresh capital when tab is active
document.getElementById('tabBar').addEventListener('click', function(e) {
  const tab = e.target.closest('.tab');
  if (!tab) return;
  if (tab.dataset.tab === 'capital') {
    fetchCapital();
    fetchTransferHistory();
    if (!capitalInterval) capitalInterval = setInterval(function() { fetchCapital(); fetchTransferHistory(); }, 10000);
  } else {
    if (capitalInterval) { clearInterval(capitalInterval); capitalInterval = null; }
  }
});

function centsToStr(c) { return '$' + (Math.abs(c) / 100).toFixed(2); }
function centsToSigned(c) { return (c >= 0 ? '+' : '-') + centsToStr(c); }

function fetchCapital() {
  fetch('/api/capital')
    .then(r => { if (!r.ok) throw new Error('Error ' + r.status); return r.json(); })
    .then(data => { capitalData = data; renderCapital(); })
    .catch(err => {
      document.getElementById('capitalRefresh').textContent = err.message;
    });
}

function renderCapital() {
  if (!capitalData) return;
  const d = capitalData;

  // Header total
  const totalEl = document.getElementById('capitalTotal');
  if (d.real_balance !== null) {
    totalEl.textContent = '$' + (d.real_balance / 100).toFixed(2);
    totalEl.className = 'capital-total ' + pnlClass(d.real_balance);
  } else {
    totalEl.textContent = '$' + (d.total_allocated / 100).toFixed(2) + ' allocated';
    totalEl.className = 'capital-total';
  }
  document.getElementById('capitalRefresh').textContent = 'Updated ' + new Date().toLocaleTimeString();

  // Cards: one per account + unallocated
  const container = document.getElementById('capitalCards');
  container.innerHTML = '';

  // Unallocated card
  const unCard = document.createElement('div');
  unCard.className = 'sub-card';
  unCard.style.borderLeftColor = 'var(--accent)';
  var unBal, unLabel, unSub;
  if (d.real_balance !== null) {
    unBal = d.unallocated !== null ? d.unallocated : 0;
    unLabel = '$' + (Math.abs(unBal) / 100).toFixed(2);
    unSub = 'Real balance ($' + (d.real_balance / 100).toFixed(2) + ') minus allocations ($' + (d.total_allocated / 100).toFixed(2) + ')';
  } else {
    unBal = 0;
    unLabel = 'No Kalshi API key';
    unSub = 'Total allocated: $' + (d.total_allocated / 100).toFixed(2) + ' across ' + d.accounts.length + ' bot' + (d.accounts.length !== 1 ? 's' : '') + '. Connect Kalshi API to see remaining balance.';
  }
  unCard.innerHTML =
    '<div class="sub-card-header">' +
      '<span class="sub-card-label">Unallocated</span>' +
      '<span class="sub-card-badge">POOL</span>' +
    '</div>' +
    '<div class="sub-card-balance ' + pnlClass(unBal) + '">' + unLabel + '</div>' +
    '<div class="sub-card-bot">' + unSub + '</div>';
  container.appendChild(unCard);

  // Per-bot cards
  d.accounts.forEach(function(a) {
    const card = document.createElement('div');
    card.className = 'sub-card';
    card.style.borderLeftColor = a.color || '#888';
    card.innerHTML =
      '<div class="sub-card-header">' +
        '<span class="sub-card-label">' + a.label + '</span>' +
        '<span class="sub-card-badge">' + a.id + '</span>' +
      '</div>' +
      '<div class="sub-card-balance">' + centsToStr(a.effective) + '</div>' +
      '<div class="bot-stats" style="margin-top:0.5rem">' +
        '<div class="stat-item"><div class="stat-label">Allocation</div><div class="stat-value">' + centsToStr(a.allocation) + '</div></div>' +
        '<div class="stat-item"><div class="stat-label">P&L</div><div class="stat-value ' + pnlClass(a.pnl) + '">' + centsToSigned(a.pnl) + '</div></div>' +
      '</div>';
    container.appendChild(card);
  });

  // Allocate form: populate bot dropdown (only bots not yet allocated)
  const allocatedIds = d.accounts.map(function(a) { return a.id; });
  const allocSel = document.getElementById('allocBot');
  const prevAlloc = allocSel.value;
  allocSel.innerHTML = '';
  BOT_IDS.forEach(function(id) {
    if (allocatedIds.indexOf(id) === -1) {
      allocSel.innerHTML += '<option value="' + id + '">' + BOTS[id].name + '</option>';
    }
  });
  // Also allow re-allocating existing bots (to update amount)
  d.accounts.forEach(function(a) {
    allocSel.innerHTML += '<option value="' + a.id + '">' + a.label + ' (update)</option>';
  });
  if (prevAlloc) allocSel.value = prevAlloc;

  // Auto-fill label when bot selected
  allocSel.onchange = function() {
    const id = allocSel.value;
    if (BOTS[id]) document.getElementById('allocLabel').value = BOTS[id].name;
  };
  // Trigger initial fill if empty
  if (!document.getElementById('allocLabel').value && allocSel.value && BOTS[allocSel.value]) {
    document.getElementById('allocLabel').value = BOTS[allocSel.value].name;
  }

  // Transfer dropdowns: all accounts + unallocated
  ['xferFrom', 'xferTo'].forEach(function(selId) {
    const sel = document.getElementById(selId);
    const prev = sel.value;
    sel.innerHTML = '<option value="unallocated">Unallocated</option>';
    d.accounts.forEach(function(a) {
      sel.innerHTML += '<option value="' + a.id + '">' + a.label + ' (' + centsToStr(a.allocation) + ')</option>';
    });
    if (prev) sel.value = prev;
  });

  // Management table
  const tbody = document.getElementById('mgmtBody');
  tbody.innerHTML = '';
  d.accounts.forEach(function(a) {
    const tr = document.createElement('tr');
    tr.innerHTML =
      '<td>' + a.id + '</td>' +
      '<td>' + a.label + '</td>' +
      '<td>' + centsToStr(a.allocation) + '</td>' +
      '<td class="' + pnlClass(a.pnl) + '">' + centsToSigned(a.pnl) + '</td>' +
      '<td>' + centsToStr(a.effective) + '</td>' +
      '<td><button class="btn btn-red btn-small" onclick="removeAllocation(\'' + a.id + '\')">Remove</button></td>';
    tbody.appendChild(tr);
  });
  if (d.accounts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="color:var(--text-dim);text-align:center">No allocations yet</td></tr>';
  }
}

function doAllocate() {
  const botId = document.getElementById('allocBot').value;
  const label = document.getElementById('allocLabel').value.trim();
  const amt = parseFloat(document.getElementById('allocAmount').value);
  const fb = document.getElementById('allocFeedback');
  if (!botId) { fb.textContent = 'Select a bot'; fb.className = 'feedback err'; return; }
  if (!label) { fb.textContent = 'Label is required'; fb.className = 'feedback err'; return; }
  if (isNaN(amt) || amt < 0) { fb.textContent = 'Enter a valid amount'; fb.className = 'feedback err'; return; }
  document.getElementById('allocBtn').disabled = true;
  fetch('/api/capital/allocate', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({bot_id: botId, label: label, amount: amt})
  })
  .then(r => r.json().then(d => ({ok: r.ok, data: d})))
  .then(function(res) {
    fb.textContent = res.ok ? 'Allocated $' + amt.toFixed(2) + ' to ' + label : (res.data.error || 'Failed');
    fb.className = 'feedback ' + (res.ok ? 'ok' : 'err');
    if (res.ok) { document.getElementById('allocAmount').value = ''; fetchCapital(); fetchTransferHistory(); }
  })
  .catch(e => { fb.textContent = e.message; fb.className = 'feedback err'; })
  .finally(() => { document.getElementById('allocBtn').disabled = false; });
}

function doTransfer() {
  const from = document.getElementById('xferFrom').value;
  const to = document.getElementById('xferTo').value;
  const amt = parseFloat(document.getElementById('xferAmount').value);
  const fb = document.getElementById('xferFeedback');
  if (!amt || amt <= 0) { fb.textContent = 'Enter a valid amount'; fb.className = 'feedback err'; return; }
  if (from === to) { fb.textContent = 'From and To must differ'; fb.className = 'feedback err'; return; }
  const fromLabel = from === 'unallocated' ? 'Unallocated' : from;
  const toLabel = to === 'unallocated' ? 'Unallocated' : to;
  if (!confirm('Transfer $' + amt.toFixed(2) + ' from ' + fromLabel + ' to ' + toLabel + '?')) return;
  document.getElementById('xferBtn').disabled = true;
  fetch('/api/capital/transfer', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({from: from, to: to, amount: amt})
  })
  .then(r => r.json().then(d => ({ok: r.ok, data: d})))
  .then(function(res) {
    fb.textContent = res.ok ? 'Transfer complete' : (res.data.error || 'Transfer failed');
    fb.className = 'feedback ' + (res.ok ? 'ok' : 'err');
    if (res.ok) { document.getElementById('xferAmount').value = ''; fetchCapital(); fetchTransferHistory(); }
  })
  .catch(e => { fb.textContent = e.message; fb.className = 'feedback err'; })
  .finally(() => { document.getElementById('xferBtn').disabled = false; });
}

function removeAllocation(botId) {
  if (!confirm('Remove allocation for ' + botId + '? Funds return to unallocated pool.')) return;
  fetch('/api/capital/' + botId, {method: 'DELETE'})
    .then(r => { if (!r.ok) throw new Error('Remove failed'); return r.json(); })
    .then(() => fetchCapital())
    .catch(e => alert(e.message));
}

function fetchTransferHistory() {
  fetch('/api/capital/transfers?limit=20')
    .then(r => { if (!r.ok) throw new Error('Error'); return r.json(); })
    .then(function(data) {
      const tbody = document.getElementById('xferHistoryBody');
      tbody.innerHTML = '';
      const xfers = data.transfers || [];
      if (xfers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text-dim);text-align:center">No transfers yet</td></tr>';
        return;
      }
      xfers.forEach(function(t) {
        const tr = document.createElement('tr');
        const ts = new Date(t.ts).toLocaleString();
        const fromLabel = t.from === 'unallocated' ? 'Unallocated' : t.from;
        const toLabel = t.to === 'unallocated' ? 'Unallocated' : t.to;
        tr.innerHTML =
          '<td>' + ts + '</td>' +
          '<td>' + fromLabel + '</td>' +
          '<td>' + toLabel + '</td>' +
          '<td>' + centsToStr(t.amount) + '</td>';
        tbody.appendChild(tr);
      });
    })
    .catch(function() {});
}
</script>
</body>
</html>
